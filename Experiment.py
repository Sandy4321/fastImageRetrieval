import numpy as np
import time as t
from numpy import genfromtxt
from numba import jit
import timeit
from flask import Flask

app = Flask(__name__)

query_vector = np.array([0.10483420640230179,-0.0449552945792675,-0.0007503247470594943,-0.00047903836821205914,0.0003963352064602077,0.03420155495405197,-0.0013821149477735162,0.014671086333692074,0.03509599715471268,0.040267422795295715,0.09784147143363953,0.03875120356678963,0.0031454989220947027,-0.004353281110525131,0.0018141085747629404,-0.001163695240393281,-0.034010808914899826,0.06695042550563812,-0.0010289029451087117,-1.107480557038798e-06,0.07627813518047333,0.07055267691612244,-0.010239167138934135,0.015429358929395676,-0.01582472398877144,0.019565746188163757,0.04072001948952675,0.021580129861831665,-0.04405353590846062,0.01327564474195242,-0.0007169372984208167,0.014024722389876842,0.015627212822437286,-0.02395547367632389,0.011963274329900742,-0.06010193005204201,0.0012695967452600598,0.1452755331993103,0.015646206215023994,-0.12735947966575623,-0.00234693824313581,0.1342712640762329,-0.000656921009067446,-0.04128110408782959,0.0348949171602726,0.09709478169679642,0.004616033751517534,0.0010255018714815378,-0.0012254085158929229,0.02394537441432476,-0.0012446038890630007,-0.005649622995406389,0.005732514429837465,0.06640350818634033,-0.04398970305919647,-0.012401272542774677,-0.010733343660831451,0.005212080664932728,0.04506387189030647,0.017301073297858238,-0.0010080055799335241,-0.028038769960403442,-0.05448498576879501,-0.005791511386632919,0.009467813186347485,-0.0021077378187328577,0.009281597100198269,-0.035709306597709656,-0.01883559860289097,0.043575696647167206,0.00965161807835102,-0.01715284213423729,0.04006969928741455,-0.030535440891981125,0.056072793900966644,8.287712262244895e-05,-0.0034963018260896206,-0.048021912574768066,-0.020133860409259796,-0.015119463205337524,-0.0004405073123052716,0.00968905258923769,-0.045168694108724594,0.017401378601789474,-0.004312735982239246,0.012372544035315514,0.03502022102475166,-0.028057584539055824,0.009444177150726318,-0.036953434348106384,0.1350468546152115,0.009536701254546642,-0.03892125189304352,-0.01196927297860384,-0.00013252349162939936,-0.00296747125685215,0.002498800866305828,-0.013048852793872356,0.014163866639137268,-0.003988825250416994,0.01588417962193489,0.008469060063362122,-0.00941452570259571,0.006457668263465166,0.06242050603032112,-0.02071859873831272,0.030658308416604996,0.0031850270461291075,-0.013700742274522781,0.00746713625267148,-0.0006500272429548204,0.013538999482989311,0.00044941663509234786,-0.018677355721592903,-0.02684490755200386,-1.3453960718834423e-06,0.024606822058558464,-0.033669598400592804,-0.002829178236424923,0.0590919591486454,0.0015895947581157088,-0.0026653960812836885,0.00040503317723050714,-0.006711574736982584,-0.0005181783926673234,0.0006631943979300559,0.016432343050837517,0.0069929384626448154,0.0008415195625275373,-0.004028257913887501,-0.0011270390823483467,-0.002822177717462182,-0.016973787918686867,-0.013284808024764061,-0.005876536015421152,0.023093558847904205,-0.0033346025738865137,-0.0069899302907288074,0.0001539514196338132,0.07071665674448013,-0.0051697720773518085,-0.0016368096694350243,-0.004614944104105234,0.004426843021064997,-8.941889859670482e-07,-0.0009798677638173103,0.07370356470346451,-0.002041738713160157,0.05416848510503769,0.0012359532993286848,-0.010763376019895077,-0.0030990811064839363,-0.1092461422085762,0.00018777257355395705,-0.00036723734228871763,-0.04705903306603432,-0.10462471842765808,0.050152458250522614,3.1198581496028055e-07,-0.007524206303060055,-0.0006976148579269648,-0.019004691392183304,0.01323681976646185,-0.01926942728459835,-0.10408084094524384,-0.0044236560352146626,0.04870355501770973,0.0033109509386122227,-0.004607786890119314,-0.011634294874966145,-0.018912704661488533,-0.00040805249591358006,-0.01677911914885044,-0.028134463354945183,0.04846346750855446,-0.0015201952774077654,-0.058570653200149536,-0.012325558811426163,0.003106192220002413,0.021922830492258072,-0.0011052883928641677,-0.040603157132864,0.0048075332306325436,0.011049643158912659,-0.008821360766887665,-0.002686047460883856,-0.00529697397723794,-0.004323665983974934,-0.04017453268170357,-0.05626280978322029,-0.044572461396455765,0.030574630945920944,0.002398211508989334,-0.005781890824437141,0.006281841080635786,0.004064032342284918,-0.0071872323751449585,0.011985976248979568,0.02775721438229084,0.013274279423058033,-0.04802287742495537,-0.02412194386124611,0.00518054747954011,0.03392834961414337,0.02781657874584198,0.03582748398184776,0.00017865051631815732,-8.104046173684765e-06,-0.0154868857935071,-0.05726725980639458,0.03463643044233322,-0.0005355163593776524,-0.00018155480211135,-0.03272444009780884,-0.03214748203754425,-0.026112524792551994,0.006281680427491665,-0.0003859051794279367,-0.04146188870072365,-0.048813920468091965,-0.03369720280170441,0.05644872039556503,0.09761157631874084,-0.0017542928690090775,-9.623306596040493e-09,0.07181523740291595,0.0006709377630613744,-0.050576984882354736,0.0002998946001753211,-0.01037792582064867,-0.003571565030142665,0.0027277320623397827,-0.0007804459892213345,-0.04578631371259689,0.0075364625081419945,0.07372398674488068,-0.0029469123110175133,0.002752101281657815,-0.05166899785399437,-0.0039283353835344315,0.007600178476423025,0.10976101458072662,-0.00816177949309349,-0.0036280634813010693,-0.001056739129126072,-0.00019263505237177014,-0.024075336754322052,0.0020532975904643536,0.005958437919616699,0.005233209580183029,-0.10973299294710159,0.0037228206638246775,-0.01705319620668888,0.021268906071782112,0.012156852521002293,-0.010368980467319489,-0.05315463989973068,0.001966125098988414,-0.03210683912038803,0.0014136775862425566,0.003709540469571948,-0.007447842974215746,-0.004728261847048998,-0.0026377576868981123,0.02733118273317814,0.015550420619547367,0.03935021534562111,0.03555874153971672,0.007064415141940117,0.020953809842467308,0.030441943556070328,0.0019010865362361073,-0.004229360725730658,0.0899796262383461,0.0003939095768146217,0.013050642795860767,-0.009279160760343075,0.0966317355632782,0.001338959438726306,0.0008208158542402089,-0.010727766901254654,0.017756730318069458,-0.016184937208890915,0.00652876403182745,0.00035136088263243437,-0.01348206214606762,0.058077145367860794,0.01639573648571968,-0.012619875371456146,-3.0755188618059037e-07,0.0003684086841531098,-9.183394286083058e-05,0.04029308632016182,-0.03497931361198425,-0.0055451104417443275,0.044592007994651794,0.025824444368481636,0.006159332115203142,-0.010445361956954002,0.0016159798251464963,-0.0003704182163346559,-0.005603136960417032,-0.0009824077133089304,-0.024558547884225845,0.0018597920425236225,0.021453458815813065,0.00038799739559181035,0.011944536119699478,0.08987320214509964,0.00118308886885643,-0.015231197699904442,-0.04529532045125961,0.012921863235533237,0.00386079796589911,-0.013992353342473507,-0.011166008189320564,-0.05692338943481445,0.04642218351364136,0.0188990980386734,-0.07722064852714539,9.097628321796947e-07,-0.0015644272789359093,-0.023366814479231834,0.01386701688170433,-0.00048473424976691604,0.0014886980643495917,-0.0601327158510685,-0.02021941728889942,-0.015942547470331192,0.02064085565507412,-0.0002625756314955652,-0.0008737058960832655,0.039823979139328,-0.0001178272650577128,0.04779328778386116,-0.05351129174232483,2.701768551105488e-07,0.021918144077062607,0.01097919512540102,-0.0036005170550197363,-0.03972875326871872,0.022257139906287193,-0.01191906537860632,0.0013692787615582347,-0.017762448638677597,-0.0009470739169046283,-0.0014225179329514503,0.016346266493201256,0.030461400747299194,0.046322472393512726,0.045658137649297714,0.021636992692947388,-0.019999979063868523,-0.0020116500090807676,-0.022271500900387764,-0.013445461168885231,-0.001392928184941411,-0.008253638632595539,0.011271498166024685,0.017900556325912476,0.05374494194984436,0.10037865489721298,-0.011481242254376411,0.00035781366750597954,0.029207460582256317,-0.0011218150611966848,-0.016537470743060112,0.01748223789036274,-0.04690931364893913,-0.09748142212629318,0.0012383569264784455,-0.002383430488407612,0.010695007629692554,0.0035617973189800978,0.0014101910637691617,0.029845278710126877,0.029355939477682114,-0.0013764514587819576,-0.005081355571746826,-0.00136841950006783,-0.04915308207273483,9.96708763523202e-07,0.028270617127418518,0.029918991029262543,-0.0026282367762178183,-0.0019261986017227173,-0.02981245145201683,-0.006974596995860338,0.03774057328701019,-0.0035353132989257574,0.006586593110114336,-0.009839652106165886,0.10387639701366425,-0.009224430657923222,-0.003938696812838316,-0.011166607029736042,-0.012064431793987751,0.020418349653482437,-0.005845861043781042,0.028832614421844482,0.013012619689106941,-0.00015438983973581344,0.000983829260803759,0.0019607949070632458,-0.0039493669755756855,-0.015547539107501507,0.07851263135671616,0.0386003702878952,-0.0018503561150282621,-0.01598259247839451,0.09525949507951736,0.044561468064785004,0.03156035766005516,0.0112895043566823,0.025847528129816055,-0.006595947779715061,-0.009492180310189724,0.0030330433510243893,-0.006906741298735142,0.08776635676622391,0.02517717517912388,-0.019762543961405754,0.013560534454882145,-0.017077937722206116,0.06932194530963898,0.003945863805711269,0.019658448174595833,-0.004885990172624588,0.030221305787563324,-0.008441813290119171,0.01829954795539379,-0.014537084847688675,-0.007369459606707096,-0.1494276225566864,-0.048613112419843674,-0.007596777752041817,0.009159279055893421,0.019628411158919334,-0.00528516573831439,-0.06480123847723007,0.008714208379387856,-0.0003936025022994727,0.010267318226397038,0.004131471272557974,-0.04058344289660454,0.06963349878787994,-0.0025671799667179585,-0.027261292561888695,0.010491420514881611,-0.009109816513955593,0.012289823964238167,-0.0030127374920994043,-0.02608836628496647,-0.0037018985021859407,-0.005969103425741196,-0.017351878806948662,-0.035575009882450104,0.005948774982243776,-0.0724705383181572,0.032935719937086105,0.01298552192747593,0.008448404259979725,-0.03891441226005554,0.0014418982900679111,0.021193720400333405,0.004078332334756851,-0.017667055130004883,-0.01109619066119194,0.10376337170600891,0.0008421452366746962,-0.06821677088737488,0.006700660102069378,0.037977900356054306,0.0036662400234490633,0.006099738646298647,-0.00980423018336296,0.05868442729115486,0.008461701683700085,0.03378932923078537,0.03064434602856636,0.0015766752185299993,0.035665400326251984,-0.04472342133522034,0.05848151817917824,-0.007530436385422945,5.874526891602727e-07,0.007764491252601147,-0.00033460938720963895,0.020944423973560333,0.013330545276403427,0.0019381181336939335,-0.013284406624734402,0.0009558013989590108,-0.01741729862987995,-0.017263688147068024,0.015187084674835205,-0.009620841592550278,0.00048516172682866454,-0.0015687476843595505,-0.0320257768034935,0.004555736668407917,-0.023620134219527245,6.510969683404255e-07,0.032761406153440475,-0.021097037941217422,-0.020122408866882324,-0.0034058496821671724,-0.005951985716819763,-0.014325934462249279,0.0002195836277678609,-0.010201931931078434,0.0034275732468813658])

@jit
def quicksort(a, s, e):
    if (e-s)==0:
        return
    pivot = a[e-1]
    p1 = s
    p2 = e - 1
    while (p1 != p2):
        if (a[p1] > pivot):
            a[p2] = a[p1]
            a[p1] = a[p2-1]
            a[p2-1] = pivot
            p2 = p2 -1
        else:
            p1+=1
    quicksort(a, s, p2)
    quicksort(a, p2+1, e)

def quicksortwrapper(a):
    quicksort(a, 0, len(a))

def timequicksort(a):
    def quick_sort():
        quicksortwrapper(a)
    return timeit.timeit(quick_sort, number =1)


my_data = genfromtxt('all.csv', delimiter=',')
print(my_data.shape)

@app.route("/img")
def hello():
    start = t.time()
    style_ids = my_data[:,0]; vectors = my_data[:,1:]
    mat= (vectors - query_vector)**2
    summ = np.dot(mat, np.ones(mat.shape[1])) #np.dot is faster than np.sum
    # https://stackoverflow.com/questions/13567345/how-to-calculate-the-sum-of-all-columns-of-a-2d-numpy-array-efficiently
    # summ = np.sum(mat, axis=1, dtype='float')
    result = np.sqrt(summ)

    # print(result)
    print((t.time()-start))
    # print(result.shape)
    start = t.time()
    timequicksort(result)
    print((t.time()-start))
    # print(result[1000])
    # print(result[9999])
    # print(result[-1])
    return "Hello"

if __name__ == '__main__':
        app.run(host='0.0.0.0', port=9002,debug=True)